<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Particle system</title>
    <link rel="icon" href="book.ico" type="image/x-icon">
    <link href="style/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://stackedit.io/style.css" />

    <style>
        .stackedit__html {
            max-width: 1200px;
            font-size: 20px;
        }
    </style>
</head>

<body class="stackedit">

<header>
    <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">

            <a href="index.html" class="navbar-brand d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width ="30" height = "20" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="150 0 400 512.87" style="fill: #ffffff;"><path fill-rule="nonzero" d="M35.7 32.95h33.54V11.18C69.24 5.01 74.25 0 80.43 0c6.17 0 11.18 5.01 11.18 11.18v21.77h49.21V11.18c0-6.17 5.01-11.18 11.19-11.18 6.17 0 11.18 5.01 11.18 11.18v21.77h49.21V11.18C212.4 5.01 217.41 0 223.59 0c6.17 0 11.18 5.01 11.18 11.18v21.77h49.21V11.18c0-6.17 5.01-11.18 11.19-11.18 6.17 0 11.18 5.01 11.18 11.18v21.77h34.55c9.83 0 18.76 4.03 25.21 10.49 5.36 5.35 9.04 12.4 10.15 20.23h.04c9.82 0 18.76 4.03 25.21 10.48C407.98 80.62 412 89.56 412 99.37v376.8c0 9.77-4.04 18.7-10.49 25.17-6.51 6.5-15.45 10.53-25.21 10.53H67.71c-9.81 0-18.75-4.02-25.22-10.49-6.14-6.14-10.09-14.53-10.45-23.8-8.36-.86-15.9-4.66-21.55-10.31C4.03 460.82 0 451.89 0 442.06V68.65c0-9.83 4.03-18.77 10.48-25.22 6.45-6.45 15.39-10.48 25.22-10.48zm340.9 51.06v358.05c0 9.8-4.03 18.74-10.49 25.2-6.47 6.47-15.41 10.5-25.21 10.5H52.43c.39 3.59 2.01 6.82 4.44 9.25 2.79 2.79 6.64 4.53 10.84 4.53H376.3c4.22 0 8.07-1.74 10.85-4.52 2.78-2.78 4.52-6.63 4.52-10.85V99.37c0-4.2-1.74-8.05-4.54-10.84a15.334 15.334 0 0 0-10.53-4.52zm-294 302.37c-5.74 0-10.4-4.86-10.4-10.85 0-5.99 4.66-10.85 10.4-10.85h214.78c5.74 0 10.41 4.86 10.41 10.85 0 5.99-4.67 10.85-10.41 10.85H82.6zm0-71.58c-5.74 0-10.4-4.86-10.4-10.85 0-5.99 4.66-10.85 10.4-10.85h214.78c5.74 0 10.41 4.86 10.41 10.85 0 5.99-4.67 10.85-10.41 10.85H82.6zm0-71.58c-5.74 0-10.4-4.86-10.4-10.85 0-5.99 4.66-10.85 10.4-10.85h214.78c5.74 0 10.41 4.86 10.41 10.85 0 5.99-4.67 10.85-10.41 10.85H82.6zm0-71.58c-5.74 0-10.4-4.86-10.4-10.85 0-5.99 4.66-10.85 10.4-10.85h214.78c5.74 0 10.41 4.86 10.41 10.85 0 5.99-4.67 10.85-10.41 10.85H82.6zM306.35 53.28v21.77c0 6.17-5.01 11.18-11.18 11.18-6.18 0-11.19-5.01-11.19-11.18V53.28h-49.21v21.77c0 6.17-5.01 11.18-11.18 11.18-6.18 0-11.19-5.01-11.19-11.18V53.28h-49.21v21.77c0 6.17-5.01 11.18-11.18 11.18-6.18 0-11.19-5.01-11.19-11.18V53.28H91.61v21.77c0 6.17-5.01 11.18-11.18 11.18-6.18 0-11.19-5.01-11.19-11.18V53.28H35.7c-4.22 0-8.07 1.75-10.85 4.52-2.77 2.78-4.52 6.63-4.52 10.85v373.41c0 4.2 1.75 8.05 4.53 10.84 2.8 2.79 6.65 4.53 10.84 4.53h305.2c4.19 0 8.03-1.75 10.83-4.54 2.79-2.8 4.54-6.65 4.54-10.83V68.65c0-4.19-1.74-8.04-4.53-10.84-2.79-2.78-6.64-4.53-10.84-4.53h-34.55z"/></svg>
                <strong>Articles</strong>
            </a>

            <a href="https://github.com/DenDunno" class="navbar-brand d-flex align-items-center">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg xmlns="http://www.w3.org/2000/svg" width="41px" height="40px" viewBox="0 0 40 40">
                    <g id="surface1">
                        <path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 19.941406 0 C 8.914062 0 0 9.167969 0 20.507812 C 0 29.570312 5.710938 37.246094 13.632812 39.960938 C 14.625 40.164062 14.988281 39.519531 14.988281 38.976562 C 14.988281 38.5 14.957031 36.871094 14.957031 35.175781 C 9.410156 36.398438 8.253906 32.730469 8.253906 32.730469 C 7.363281 30.351562 6.042969 29.742188 6.042969 29.742188 C 4.226562 28.484375 6.171875 28.484375 6.171875 28.484375 C 8.1875 28.621094 9.242188 30.589844 9.242188 30.589844 C 11.027344 33.714844 13.898438 32.832031 15.054688 32.289062 C 15.21875 30.964844 15.746094 30.046875 16.308594 29.539062 C 11.886719 29.0625 7.230469 27.296875 7.230469 19.421875 C 7.230469 17.179688 8.023438 15.347656 9.277344 13.921875 C 9.078125 13.410156 8.386719 11.304688 9.476562 8.488281 C 9.476562 8.488281 11.160156 7.945312 14.957031 10.59375 C 16.582031 10.144531 18.257812 9.914062 19.941406 9.914062 C 21.625 9.914062 23.339844 10.152344 24.925781 10.59375 C 28.722656 7.945312 30.40625 8.488281 30.40625 8.488281 C 31.496094 11.304688 30.800781 13.410156 30.605469 13.921875 C 31.890625 15.347656 32.652344 17.179688 32.652344 19.421875 C 32.652344 27.296875 27.996094 29.027344 23.539062 29.539062 C 24.265625 30.183594 24.890625 31.40625 24.890625 33.339844 C 24.890625 36.089844 24.859375 38.296875 24.859375 38.976562 C 24.859375 39.519531 25.222656 40.164062 26.214844 39.960938 C 34.136719 37.246094 39.847656 29.570312 39.847656 20.507812 C 39.878906 9.167969 30.933594 0 19.941406 0 Z M 19.941406 0 "/>
                    </g>
                </svg>
            </a>
        </div>
    </div>
</header>

<div class="stackedit__html"><h2 id="p-aligncenterparticle-system.-source-codep"><p align="center">Particle system. <a href="https://github.com/DenDunno/Dengine#particle-system-up-to-1-million-particles">Source code</a></p></h2>
    <p>In this article, I will tell you how to build a particle system that can handle up to 1 million particles.</p>
    <p>The main 2 things you should decide when building a particle system are:</p>
    <ul>
        <li>How to render</li>
        <li>How to update</li>
    </ul>
    <p>It isn’t a big secret that particle system should be rendered with 1 draw call, cause even 10K particles (10K draw calls) could fry up your computer/phone.</p>
    <pre class=" language-mermaid"><svg id="mermaid-svg-uiWuxk1U3gHckpj5" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="518.3500366210938" style="max-width: 1122.5875244140625px;" viewBox="0 0 1122.5875244140625 518.3500366210938"><style>#mermaid-svg-uiWuxk1U3gHckpj5{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-uiWuxk1U3gHckpj5 .error-icon{fill:#552222;}#mermaid-svg-uiWuxk1U3gHckpj5 .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-uiWuxk1U3gHckpj5 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-uiWuxk1U3gHckpj5 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-uiWuxk1U3gHckpj5 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-uiWuxk1U3gHckpj5 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-uiWuxk1U3gHckpj5 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-uiWuxk1U3gHckpj5 .marker{fill:#666;stroke:#666;}#mermaid-svg-uiWuxk1U3gHckpj5 .marker.cross{stroke:#666;}#mermaid-svg-uiWuxk1U3gHckpj5 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-uiWuxk1U3gHckpj5 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#000000;}#mermaid-svg-uiWuxk1U3gHckpj5 .cluster-label text{fill:#333;}#mermaid-svg-uiWuxk1U3gHckpj5 .cluster-label span{color:#333;}#mermaid-svg-uiWuxk1U3gHckpj5 .label text,#mermaid-svg-uiWuxk1U3gHckpj5 span{fill:#000000;color:#000000;}#mermaid-svg-uiWuxk1U3gHckpj5 .node rect,#mermaid-svg-uiWuxk1U3gHckpj5 .node circle,#mermaid-svg-uiWuxk1U3gHckpj5 .node ellipse,#mermaid-svg-uiWuxk1U3gHckpj5 .node polygon,#mermaid-svg-uiWuxk1U3gHckpj5 .node path{fill:#eee;stroke:#999;stroke-width:1px;}#mermaid-svg-uiWuxk1U3gHckpj5 .node .label{text-align:center;}#mermaid-svg-uiWuxk1U3gHckpj5 .node.clickable{cursor:pointer;}#mermaid-svg-uiWuxk1U3gHckpj5 .arrowheadPath{fill:#333333;}#mermaid-svg-uiWuxk1U3gHckpj5 .edgePath .path{stroke:#666;stroke-width:1.5px;}#mermaid-svg-uiWuxk1U3gHckpj5 .flowchart-link{stroke:#666;fill:none;}#mermaid-svg-uiWuxk1U3gHckpj5 .edgeLabel{background-color:white;text-align:center;}#mermaid-svg-uiWuxk1U3gHckpj5 .edgeLabel rect{opacity:0.5;background-color:white;fill:white;}#mermaid-svg-uiWuxk1U3gHckpj5 .cluster rect{fill:hsl(210,66.6666666667%,95%);stroke:#26a;stroke-width:1px;}#mermaid-svg-uiWuxk1U3gHckpj5 .cluster text{fill:#333;}#mermaid-svg-uiWuxk1U3gHckpj5 .cluster span{color:#333;}#mermaid-svg-uiWuxk1U3gHckpj5 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(-160,0%,93.3333333333%);border:1px solid #26a;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-uiWuxk1U3gHckpj5:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-uiWuxk1U3gHckpj5 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-A LE-B" style="opacity: 1;" id="L-A-B"><path class="path" d="M234.66750682049675,235.89062309265137L433.125018119812,95.23749828338623L478.62502098083496,95.23749828338623" marker-end="url(https://stackedit.io/app#arrowhead23)" style="fill:none"></path><defs><marker id="arrowhead23" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-A LE-C" style="opacity: 1;" id="L-A-C"><path class="path" d="M234.66750682049675,282.6031246185303L433.125018119812,423.2562494277954L470.82501792907715,423.2562494277954" marker-end="url(https://stackedit.io/app#arrowhead24)" style="fill:none"></path><defs><marker id="arrowhead24" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-C LE-D" style="opacity: 1;" id="L-C-D"><path class="path" d="M743.3841822311542,399.89999866485596L929.7750177383423,329.6093740463257L978.8462105313735,298.60666815246947" marker-end="url(https://stackedit.io/app#arrowhead25)" style="fill:none"></path><defs><marker id="arrowhead25" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-C LE-F" style="opacity: 1;" id="L-C-F"><path class="path" d="M892.0750179290771,443.0666193859349L929.7750177383423,446.61249923706055L977.2937698364258,446.61249923706055" marker-end="url(https://stackedit.io/app#arrowhead26)" style="fill:none"></path><defs><marker id="arrowhead26" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-B LE-E" style="opacity: 1;" id="L-B-E"><path class="path" d="M884.2750148773193,76.16075893001793L929.7750177383423,71.8812484741211L977.150016784668,71.8812484741211" marker-end="url(https://stackedit.io/app#arrowhead27)" style="fill:none"></path><defs><marker id="arrowhead27" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-B LE-D" style="opacity: 1;" id="L-B-D"><path class="path" d="M743.3366837910535,118.59374904632568L929.7750177383423,188.95624828338623L978.8643521061344,220.00212891810204" marker-end="url(https://stackedit.io/app#arrowhead28)" style="fill:none"></path><defs><marker id="arrowhead28" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" style="opacity: 1;" transform="translate(433.125018119812,95.23749828338623)"><g transform="translate(-12.699999809265137,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="25.399999618530273" height="26.712499618530273"></rect><foreignObject width="25.399999618530273" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-A-B" class="edgeLabel L-LS-A' L-LE-B">YES</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(433.125018119812,423.2562494277954)"><g transform="translate(-10.5,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="21" height="26.712499618530273"></rect><foreignObject width="21" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-A-C" class="edgeLabel L-LS-A' L-LE-C">NO</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(929.7750177383423,329.6093740463257)"><g transform="translate(-12.699999809265137,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="25.399999618530273" height="26.712499618530273"></rect><foreignObject width="25.399999618530273" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-C-D" class="edgeLabel L-LS-C' L-LE-D">YES</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(929.7750177383423,446.61249923706055)"><g transform="translate(-10.5,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="21" height="26.712499618530273"></rect><foreignObject width="21" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-C-F" class="edgeLabel L-LS-C' L-LE-F">NO</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(929.7750177383423,71.8812484741211)"><g transform="translate(-12.699999809265137,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="25.399999618530273" height="26.712499618530273"></rect><foreignObject width="25.399999618530273" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-B-E" class="edgeLabel L-LS-B' L-LE-E">YES</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(929.7750177383423,188.95624828338623)"><g transform="translate(-10.5,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="21" height="26.712499618530273"></rect><foreignObject width="21" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-B-D" class="edgeLabel L-LS-B' L-LE-D">NO</span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" style="opacity: 1;" id="flowchart-A-100" transform="translate(201.71250915527344,259.2468738555908)"><rect rx="5" ry="5" x="-193.71250915527344" y="-23.356249809265137" width="387.4250183105469" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-183.71250915527344,-13.356249809265137)"><foreignObject width="367.4250183105469" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Do your particles supposed to have different mesh?</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-B-101" transform="translate(681.4500179290771,95.23749828338623)"><rect rx="5" ry="5" x="-202.8249969482422" y="-23.356249809265137" width="405.6499938964844" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-192.8249969482422,-13.356249809265137)"><foreignObject width="385.6499938964844" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Do all of your particles supposed to be always visible?</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-C-103" transform="translate(681.4500179290771,423.2562494277954)"><rect rx="5" ry="5" x="-210.625" y="-23.356249809265137" width="421.25" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-200.625,-13.356249809265137)"><foreignObject width="401.25" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Is it important for you compatibility with old platforms?</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-D-105" transform="translate(1041.0312690734863,259.3187484741211)"><circle x="-73.5562515258789" y="-23.356249809265137" r="73.5562515258789" class="label-container"></circle><g class="label" transform="translate(0,0)"><g transform="translate(-63.556251525878906,-13.356249809265137)"><foreignObject width="127.11250305175781" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Dynamic batching</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-F-107" transform="translate(1041.0312690734863,446.61249923706055)"><circle x="-63.73749923706055" y="-23.356249809265137" r="63.73749923706055" class="label-container"></circle><g class="label" transform="translate(0,0)"><g transform="translate(-53.73749923706055,-13.356249809265137)"><foreignObject width="107.4749984741211" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">GPU instancing</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-E-109" transform="translate(1041.0312690734863,71.8812484741211)"><circle x="-63.88125228881836" y="-23.356249809265137" r="63.88125228881836" class="label-container"></circle><g class="label" transform="translate(0,0)"><g transform="translate(-53.88125228881836,-13.356249809265137)"><foreignObject width="107.76250457763672" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Static batching</div></foreignObject></g></g></g></g></g></g></svg></pre>
    <p>For example, unity uses dynamic batching but also offers GPU instancing. In our case, we will use the last one.</p>
    <p>Okay, we’ve dealt with the first question. What about an update?<br>
        We have 3 choices:</p>
    <ul>
        <li>Synchronous execution at CPU</li>
        <li>Multithreaded execution at CPU</li>
        <li>Execution at GPU (compute shader)</li>
    </ul>
    <p>It’s a theme of discussion about what and when would be run faster, but when the amount of particles is too big (for example million), you should use compute shader for particles update for better performance.</p>
    <p>Deal. GPU instancing for rendering and compute shader for update. How we can connect compute shader and rendering stage? Answer: SSBO (shader storage buffer object). Note, that SSBO works starting at OpenGL version  4.3</p>
    <p>Here is the main particle system loop:</p>
    <pre class=" language-mermaid"><svg id="mermaid-svg-JpSarXlLjxD8Y4WS" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="206.13751220703125" style="max-width: 540.9300537109375px;" viewBox="0 0 540.9300537109375 206.13751220703125"><style>#mermaid-svg-JpSarXlLjxD8Y4WS{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-JpSarXlLjxD8Y4WS .error-icon{fill:#552222;}#mermaid-svg-JpSarXlLjxD8Y4WS .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-JpSarXlLjxD8Y4WS .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-JpSarXlLjxD8Y4WS .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-JpSarXlLjxD8Y4WS .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-JpSarXlLjxD8Y4WS .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-JpSarXlLjxD8Y4WS .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-JpSarXlLjxD8Y4WS .marker{fill:#666;stroke:#666;}#mermaid-svg-JpSarXlLjxD8Y4WS .marker.cross{stroke:#666;}#mermaid-svg-JpSarXlLjxD8Y4WS svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-JpSarXlLjxD8Y4WS .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#000000;}#mermaid-svg-JpSarXlLjxD8Y4WS .cluster-label text{fill:#333;}#mermaid-svg-JpSarXlLjxD8Y4WS .cluster-label span{color:#333;}#mermaid-svg-JpSarXlLjxD8Y4WS .label text,#mermaid-svg-JpSarXlLjxD8Y4WS span{fill:#000000;color:#000000;}#mermaid-svg-JpSarXlLjxD8Y4WS .node rect,#mermaid-svg-JpSarXlLjxD8Y4WS .node circle,#mermaid-svg-JpSarXlLjxD8Y4WS .node ellipse,#mermaid-svg-JpSarXlLjxD8Y4WS .node polygon,#mermaid-svg-JpSarXlLjxD8Y4WS .node path{fill:#eee;stroke:#999;stroke-width:1px;}#mermaid-svg-JpSarXlLjxD8Y4WS .node .label{text-align:center;}#mermaid-svg-JpSarXlLjxD8Y4WS .node.clickable{cursor:pointer;}#mermaid-svg-JpSarXlLjxD8Y4WS .arrowheadPath{fill:#333333;}#mermaid-svg-JpSarXlLjxD8Y4WS .edgePath .path{stroke:#666;stroke-width:1.5px;}#mermaid-svg-JpSarXlLjxD8Y4WS .flowchart-link{stroke:#666;fill:none;}#mermaid-svg-JpSarXlLjxD8Y4WS .edgeLabel{background-color:white;text-align:center;}#mermaid-svg-JpSarXlLjxD8Y4WS .edgeLabel rect{opacity:0.5;background-color:white;fill:white;}#mermaid-svg-JpSarXlLjxD8Y4WS .cluster rect{fill:hsl(210,66.6666666667%,95%);stroke:#26a;stroke-width:1px;}#mermaid-svg-JpSarXlLjxD8Y4WS .cluster text{fill:#333;}#mermaid-svg-JpSarXlLjxD8Y4WS .cluster span{color:#333;}#mermaid-svg-JpSarXlLjxD8Y4WS div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(-160,0%,93.3333333333%);border:1px solid #26a;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-JpSarXlLjxD8Y4WS:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-JpSarXlLjxD8Y4WS flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-CPU LE-Update" style="opacity: 1;" id="L-CPU-Update"><path class="path" d="M56.875,122.417072814268L123.01250076293945,174.78125190734863L189.1500015258789,174.78125190734863" marker-end="url(https://stackedit.io/app#arrowhead29)" style="fill:none"></path><defs><marker id="arrowhead29" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-CPU LE-Rendering" style="opacity: 1;" id="L-CPU-Rendering"><path class="path" d="M56.875,83.72042985602009L123.01250076293945,31.356250762939453L244.49375534057617,31.356250762939453" marker-end="url(https://stackedit.io/app#arrowhead30)" style="fill:none"></path><defs><marker id="arrowhead30" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Rendering LE-SSBO" style="opacity: 1;" id="L-Rendering-SSBO"><path class="path" d="M335.8312568664551,31.356250762939453L416.17501068115234,31.356250762939453L464.7480889183173,80.4956739562859" marker-end="url(https://stackedit.io/app#arrowhead31)" style="fill:none"></path><defs><marker id="arrowhead31" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-CPU LE-SSBO" style="opacity: 1;" id="L-CPU-SSBO"><path class="path" d="M56.875,103.06875133514404L123.01250076293945,103.06875133514404L290.1625061035156,103.06875133514404L416.17501068115234,103.06875133514404L441.6750115394591,103.5687513351441" marker-end="url(https://stackedit.io/app#arrowhead32)" style="fill:none"></path><defs><marker id="arrowhead32" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Update LE-SSBO" style="opacity: 1;" id="L-Update-SSBO"><path class="path" d="M391.17501068115234,174.78125190734863L416.17501068115234,174.78125190734863L464.7480880650367,126.64182957733517" marker-end="url(https://stackedit.io/app#arrowhead33)" style="fill:none"></path><defs><marker id="arrowhead33" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" style="opacity: 1;" transform="translate(123.01250076293945,174.78125190734863)"><g transform="translate(-41.13750076293945,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="82.2750015258789" height="26.712499618530273"></rect><foreignObject width="82.2750015258789" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-CPU-Update" class="edgeLabel L-LS-CPU' L-LE-Update">Update call</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(123.01250076293945,31.356250762939453)"><g transform="translate(-33.46875,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="66.9375" height="26.712499618530273"></rect><foreignObject width="66.9375" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-CPU-Rendering" class="edgeLabel L-LS-CPU' L-LE-Rendering">Draw call</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform=""><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-Rendering-SSBO" class="edgeLabel L-LS-Rendering' L-LE-SSBO"></span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform="translate(290.1625061035156,103.06875133514404)"><g transform="translate(-30.631250381469727,-13.356249809265137)" class="label"><rect rx="0" ry="0" width="61.26250076293945" height="26.712499618530273"></rect><foreignObject width="61.26250076293945" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-CPU-SSBO" class="edgeLabel L-LS-CPU' L-LE-SSBO">Emission</span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform=""><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-Update-SSBO" class="edgeLabel L-LS-Update' L-LE-SSBO"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" style="opacity: 1;" id="flowchart-CPU-122" transform="translate(32.4375,103.06875133514404)"><rect rx="5" ry="5" x="-24.4375" y="-23.356249809265137" width="48.875" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-14.4375,-13.356249809265137)"><foreignObject width="28.875" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">CPU</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-Update-123" transform="translate(290.1625061035156,174.78125190734863)"><rect rx="5" ry="5" x="-101.01250457763672" y="-23.356249809265137" width="202.02500915527344" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-91.01250457763672,-13.356249809265137)"><foreignObject width="182.02500915527344" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Update - compute shader</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-Rendering-125" transform="translate(290.1625061035156,31.356250762939453)"><rect rx="5" ry="5" x="-45.66875076293945" y="-23.356249809265137" width="91.3375015258789" height="46.71249961853027" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-35.66875076293945,-13.356249809265137)"><foreignObject width="71.3375015258789" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Rendering</div></foreignObject></g></g></g><g class="node default" style="opacity: 1;" id="flowchart-SSBO-127" transform="translate(487.0525093078613,103.06875133514404)"><polygon points="45.87749948501587,0 91.75499897003174,-45.87749948501587 45.87749948501587,-91.75499897003174 0,-45.87749948501587" transform="translate(-45.87749948501587,45.87749948501587)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-17.618749618530273,-13.356249809265137)"><foreignObject width="35.23749923706055" height="26.712499618530273"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">SSBO</div></foreignObject></g></g></g></g></g></g></svg></pre>
    <pre class=" language-c"><code class="prism # language-c">public class ParticleSystem <span class="token punctuation">:</span> IDrawable
<span class="token punctuation">{</span>
    public bool Emitting <span class="token operator">=</span> true<span class="token punctuation">;</span>
    public readonly Transform Transform<span class="token punctuation">;</span>
    private readonly ParticlesUpdate _update<span class="token punctuation">;</span>
    private readonly ParticlesView _view<span class="token punctuation">;</span>
    private readonly Timer _timer<span class="token punctuation">;</span>

    public <span class="token function">ParticleSystem</span><span class="token punctuation">(</span>Transform transform<span class="token punctuation">,</span> ParticleSystemData data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Transform <span class="token operator">=</span> transform<span class="token punctuation">;</span>
        _timer <span class="token operator">=</span> new <span class="token function">LocalTimer</span><span class="token punctuation">(</span><span class="token number">1f</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>ParticlesPerSecond<span class="token punctuation">,</span> Emit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _view <span class="token operator">=</span> new <span class="token function">ParticlesView</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _update <span class="token operator">=</span> new <span class="token function">ParticlesUpdate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> IGameComponent<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _view<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _update<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> IGameComponent<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">float</span> deltaTime<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _update<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>Emitting<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _timer<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    private <span class="token keyword">void</span> <span class="token function">Emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _update<span class="token punctuation">.</span><span class="token function">Emit</span><span class="token punctuation">(</span>Transform<span class="token punctuation">.</span>Position<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_timer<span class="token punctuation">.</span>Difference <span class="token operator">/</span> _timer<span class="token punctuation">.</span>Rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public <span class="token keyword">void</span> <span class="token function">Draw</span><span class="token punctuation">(</span>in Matrix4 projectionMatrix<span class="token punctuation">,</span> in Matrix4 viewMatrix<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _view<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span>in projectionMatrix<span class="token punctuation">,</span> in viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _view<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>It’s worth mentioning that <strong>emission is the main bottleneck</strong> in this implementation of the particle system because there is a call for SSBO (data that stores at GPU) from a CPU.</p>
    <p>In general, different kind of calls from CPU to GPU commonly becomes a bottleneck.</p>
    <p align="center">
        <img src="https://raw.githubusercontent.com/DenDunno/Articles/main/images/particleSystem/particleSystem.gif" alt="final result. Animated grid with a different geometry and colors rendered with a single draw call">
    </p>
</div>
</body>

</html>
